---
sort: 50
---
# 插件集成

## Prometheus

Prometheus是一个开源的监控和警报工具集，目标是提供可靠的实时监控和警报，专为动态的云环境和微服务架构设计。

```bash
$ kubectl -n istio-system apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/prometheus.yaml
```

在istio中，通过开启`指标合并`将`prometheus.io`注解添加到sidecar中来设置手机指标（若已存在会被覆盖），并通过:15020/stats/prometheus暴露给prometheus收集。

配置istio开启指标合并

```bash
$ kubectl -n istio-system apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio
  namespace: istio-system
data:
  mesh: |-
    defaultConfig:
      discoveryAddress: istiod.istio-system.svc:15012
      tracing:
        zipkin:
          address: zipkin.istio-system:9411
    enablePrometheusMerge: true # [!code ++]
    accessLogFile: /dev/stdout
    rootNamespace: istio-system
    trustDomain: cluster.local
EOF
```

prometheus通过注解对服务指标进行抓取

```yaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    istio.io/rev: default
    kubectl.kubernetes.io/default-container: tcp-echo
    kubectl.kubernetes.io/default-logs-container: tcp-echo
    prometheus.io/path: /stats/prometheus # [!code warning]
    prometheus.io/port: "15020" # [!code warning]
    prometheus.io/scrape: "true" # [!code warning] # 是否要抓取该服务的数据
    sidecar.istio.io/status: '{"initContainers":["istio-init"],"containers":["istio-proxy"],"volumes":["workload-socket","credential-socket","workload-certs","istio-envoy","istio-data","istio-podinfo","istio-token","istiod-ca-cert"],"imagePullSecrets":null,"revision":"default"}'
  creationTimestamp: "2024-01-29T01:41:57Z"
  generateName: tcp-echo-54b7ccdc9-
  labels:
    app: tcp-echo
    pod-template-hash: 54b7ccdc9
    security.istio.io/tlsMode: istio
    service.istio.io/canonical-name: tcp-echo
    service.istio.io/canonical-revision: v1
    version: v1
  name: tcp-echo-54b7ccdc9-m4g6t
  namespace: test
```

修改svc，基于NodePort对外暴露

```bash
$ kubectl -n istio-system patch svc prometheus --type='json' -p='[
{"op":"replace","path":"/spec/type","value":"NodePort"},{"op":"replace","path":"/spec/ports/0/nodePort","value":30008}
]'
```

浏览器访问IP:30009查看prometheus服务能否正常响应

![prometheus](https://image.leejay.top/typora/prometheus.jpg)

## Grafana

Grafana是一个开源的数据可视化和监控平台，用于创建和共享动态、交互式的仪表板。

```bash
$ kubectl -n istio-system apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/grafana.yaml
```

修改svc，基于NodePort对外暴露

```bash
$ kubectl -n istio-system patch svc grafana --type='json' -p='[
{"op":"replace","path":"/spec/type","value":"NodePort"},{"op":"replace","path":"/spec/ports/0/nodePort","value":30000}
]'
```

浏览器访问IP:30000查看grafana服务能否正常响应

![grafana](https://image.leejay.top/typora/grafana.jpg)

## Kiali

:::info

kiali是一个用于在微服务架构中提供监控和可观测性的开源工具。通过提供可视化的监控和分析工具，Kiali使用户能够`快速诊断问题`、`优化性能`，并确保微服务系统的可靠运行。

:::

```bash
# prometheus & kiali & grafana & jaeger
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/prometheus.yaml
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/grafana.yaml
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/jaeger.yaml
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/kiali.yaml
```

> kiali的分布式追踪依靠[jaeger](https://www.jaegertracing.io/)来实现

```bash
# 修改kiali配置
$ kubectl -n istio-system edit cm kiali -o yaml
# 修改如下配置
external_services:
  grafana:
    enabled: true
    url: 'http://grafana.istio-system:3000/'
  tracing:
    enable: true
    use_grpc: false
    in_cluster_url: "http://tracing.istio-system/"
  prometheus:
    enable: true
    url: "http://prometheus.istio-system:9090/"
```

> 更多配置，查看集成[文档](https://kiali.io/docs/configuration/p8s-jaeger-grafana/)

## Zipkin

:::info

Zipkin是一个分布式追踪系统。它有助于收集排除服务体系结构中的延迟问题所需的定时数据。功能包括数据收集和查找。

:::

```bash
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/extras/zipkin.yaml
```

因为使用了kind部署测试环境，之前开放了docker的30000-30020端口，所以这里需要暴露zipkin的NodePort端口为30014

```bash
$ kubectl -n istio-system patch svc zipkin --type='json' -p='[
  {"op":"replace","path":"/spec/type","value":"NodePort"},
  {"op":"replace","path":"/spec/ports/0/nodePort","value":30014}
]'
```

修改配置文件，来支持zipkin的数据采集

:::code-group

```bash[configmap]
$ kubectl patch configmap istio -n istio-system --type merge -p '{"data": {"mesh": "{\"enableTracing\": true, \"defaultConfig\": {\"tracing\": {\"sampling\": 100, \"zipkin\": {\"address\": \"zipkin:9014\"}}}}}"}}'
```

```bash[istio-operator]
$ kubectl apply -f - <<EOF
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
  name: istio-operator-sample
spec:
  profile: default
  values:
    global:
      istioNamespace: istio-system # 配置istiod控制平面的ns
  meshConfig:
    enableTracing: true # 开启链路追踪
    defaultConfig: 
      tracing:
        sampling: 100 # 采样率0.0-100.0
        zipkin:
          address: zipkin:9014 # 配置zipkin的地址
EOF
```

:::

访问`节点IP:30014`来测试zipkin能否访问

![zipkin_2](https://image.leejay.top/typora/zipkin_2.jpg)

## Skywalking



## 分布式追踪系统对比

| 类别     | Apache SkyWalking                                            | Jaeger                                       | Zipkin                                       |
| :------- | :----------------------------------------------------------- | :------------------------------------------- | :------------------------------------------- |
| 实现方式 | 基于语言的探针、服务网格探针、eBPF agent、第三方指标库（当前支持 Zipkin） | 基于语言的探针                               | 基于语言的探针                               |
| 数据存储 | ES、H2、MySQL、TiDB、Sharding-sphere、BanyanDB               | ES、MySQL、Cassandra、内存                   | ES、MySQL、Cassandra、内存                   |
| 支持语言 | Java、Rust、PHP、NodeJS、Go、Python、C++、.NET、Lua          | Java、Go、Python、NodeJS、C#、PHP、Ruby、C++ | Java、Go、Python、NodeJS、C#、PHP、Ruby、C++ |
| 发起者   | 个人                                                         | Uber                                         | Twitter                                      |
| 治理方式 | Apache Foundation                                            | CNCF                                         | CNCF                                         |
| 版本     | 9.3.0                                                        | 1.39.0                                       | 2.23.19                                      |

> [数据来源](https://skywalking.apache.org/zh/how-to-use-skywalking-for-distributed-tracing-in-istio/)
