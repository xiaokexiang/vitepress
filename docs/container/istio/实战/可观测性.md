---
sort: 50
---

# 可观测性

## 指标

## 日志

:::tip

[OpenTelemetry](https://opentelemetry.io/)是[CNCF](https://www.cncf.io/)的一个观测性项目，旨在提供可观测性领域的标准化方案，以简化在分布式系统中生成、收集、处理、导出跟踪和度量数据的过程。

:::

istio中支持配置Envoy代理以`OpenTelemetry 格式`导出访问日志，并发送到指定的[OpenTelemetry 收集器](https://github.com/open-telemetry/opentelemetry-collector)

### 基于Enovy访问日志记录

参考[此处](./服务安全#准备)部署sleep和httpbin服务。并部署[otel-collector](https://github.com/istio/istio/tree/release-1.20/samples/open-telemetry)组件用于日志数据的采集和处理。

部署otel-collector组件用来收集envoy的访问日志

```bash
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/open-telemetry/otel.yaml
```

> otel-collector支持`追踪`、`指标`、`日志`持久化到指定[组件](https://opentelemetry.io/docs/collector/configuration/#exporters)。

修改istio的配置，添加otel相关参数

```bash{15-20}
$ kubectl -n istio-system apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio
  namespace: istio-system
data:
  mesh: |-
    defaultConfig:
      discoveryAddress: istiod.istio-system.svc:15012
      tracing:
        zipkin:
          address: zipkin.istio-system:9411
    enablePrometheusMerge: true
    accessLogFile: /dev/stdout
    extensionProviders:
    - name: otel
      envoyOtelAls:
        service: opentelemetry-collector.istio-system.svc.cluster.local
        port: 4317
    rootNamespace: istio-system
    trustDomain: cluster.local
EOF
```

部署Telemetry资源告诉istio将访问日志发送到otel-collector收集器。

```bash
$ kubectl apply -f - <<EOF
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: sleep-logging
spec:
  selector:
    matchLabels:
      app: sleep # 匹配需要导出访问日志的服务
  accessLogging:
    - providers:
      - name: otel # 指定istio配置的provider
EOF
```

执行命令从sleep访问http

```bash
$ kubectl exec -it $(kubectl get po -l app=sleep -ojsonpath={.items[0].metadata.name}) -c sleep -- curl httpbin:8000/status/418
```

查看otel-collector输出的访问日志

```bash
$ kubectl -n istio-system logs -f --tail 200 -l app=opentelemetry-collector
```

访问日志如下所示（去除了不重要的数据）

```bash
Body: [2024-01-25T06:03:13.551Z] "GET /status/418 HTTP/1.1" 418 - via_upstream - "-" 0 135 9 8 "-" "curl/8.5.0" "c52dd60d-c5e7-98e6-8122-3c57483ddab2" "httpbin:8000" "10.244.0.53:80" outbound|8000||httpbin.default.svc.cluster.local 10.244.0.50:33034 10.96.67.124:8000 10.244.0.50:41772 - default
```

:::warning

sleep访问httpbin服务，访问日志会出现两条，分别是sleep的出站和httpbin的入站访问日志。因为`envoy会代理出入站流量`。

:::

### 访问日志格式

| 日志运算符                                                   | 对应sleep中的访问日志                           | httpbin 中的访问日志                            |
| ------------------------------------------------------------ | ----------------------------------------------- | ----------------------------------------------- |
| [%START_TIME%]                                               | [2020-11-25T21:26:18.409Z]                      | [2020-11-25T21:26:18.409Z]                      |
| \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" | "GET /status/418 HTTP/1.1"                      | "GET /status/418 HTTP/1.1"                      |
| %RESPONSE_CODE%                                              | 418                                             | 418                                             |
| %RESPONSE_FLAGS%                                             | -                                               | -                                               |
| %RESPONSE_CODE_DETAILS%                                      | via_upstream                                    | via_upstream                                    |
| %CONNECTION_TERMINATION_DETAILS%                             | -                                               | -                                               |
| \"%UPSTREAM_TRANSPORT_FAILURE_REASON%\"                      | "-"                                             | "-"                                             |
| %BYTES_RECEIVED%                                             | 0                                               | 0                                               |
| %BYTES_SENT%                                                 | 135                                             | 135                                             |
| %DURATION%                                                   | 4                                               | 3                                               |
| %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%                        | 4                                               | 1                                               |
| \"%REQ(X-FORWARDED-FOR)%\"                                   | "-"                                             | "-"                                             |
| \"%REQ(USER-AGENT)%\"                                        | "curl/7.73.0-DEV"                               | "curl/7.73.0-DEV"                               |
| \"REQ(X-REQUEST-ID)%\"                                       | "84961386-6d84-929d-98bd-c5aee93b5c88"          | "84961386-6d84-929d-98bd-c5aee93b5c88"          |
| \"REQ(:AUTHORITY)%\"                                         | "httpbin:8000"                                  | "httpbin:8000"                                  |
| \"UPSTREAM_HOST%\"                                           | "10.44.1.27:80"                                 | "127.0.0.1:80"                                  |
| %UPSTREAM_CLUSTER%                                           | outbound\|8000\|\|httpbin.foo.svc.cluster.local | inbound\|8000\|\|                               |
| %UPSTREAM_LOCAL_ADDRESS%                                     | 10.44.1.23:37652                                | 127.0.0.1:4185                                  |
| %DOWNSTREAM_LOCAL_ADDRESS%                                   | 10.0.45.184:800                                 | 10.44.1.27:80                                   |
| %DOWNSTREAM_REMOTE_ADDRESS%                                  | 10.44.1.23:46520                                | 10.44.1.23:37652                                |
| %REQUESTED_SERVER_NAME%                                      | -                                               | outbound_.8000_._.httpbin.foo.svc.cluster.local |
| %ROUTE_NAME%                                                 | default                                         | default                                         |

默认格式如上所示，同样我们也可以自定义需要显示的日志格式

```bash
$ kubectl -n istio-system apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio
  namespace: istio-system
data:
  mesh: |-
    defaultConfig:
      discoveryAddress: istiod.istio-system.svc:15012
      tracing:
        zipkin:
          address: zipkin.istio-system:9411
    enablePrometheusMerge: true
    accessLogFile: /dev/stdout
    extensionProviders:
    - name: otel
      envoyOtelAls:
        service: opentelemetry-collector.istio-system.svc.cluster.local
        port: 4317
        logFormat: # [!code ++]
          text: "[%START_TIME%]:\"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\"" # [!code ++]
    rootNamespace: istio-system
    trustDomain: cluster.local
EOF
```

再次发起服务请求，并查看访问日志

```bash
Body: [2024-01-25T07:42:35.182Z]:"GET /status/418 HTTP/1.1"
```

### 访问日志持久化

安装grafana-loki来存储otel-collector收集的访问日志，并通过grafana来查看。

```bash
$ kubectl -n istio-system apply -f https://raw.githubusercontent.com/istio/istio/master/samples/addons/grafana.yaml
$ kubectl -n istio-system apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/addons/loki.yaml
$ kubectl -n istio-system apply -f https://raw.githubusercontent.com/istio/istio/release-1.20/samples/open-telemetry/loki/otel.yaml
```

修改istio的配置文件

```bash
$ kubectl -n istio-system apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio
  namespace: istio-system
data:
  mesh: |-
    defaultConfig:
      discoveryAddress: istiod.istio-system.svc:15012
      tracing:
        zipkin:
          address: zipkin.istio-system:9411
    enablePrometheusMerge: true
    accessLogFile: /dev/stdout
    extensionProviders:
    - name: otel
      envoyOtelAls:
        service: opentelemetry-collector.istio-system.svc.cluster.local
        port: 4317
        logFormat:
          text: "[%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %UPSTREAM_LOCAL_ADDRESS%"
          labels: # [!code ++]
              pod: "%ENVIRONMENT(POD_NAME)%" # [!code ++]
              namespace: "%ENVIRONMENT(POD_NAMESPACE)%" # [!code ++]
              cluster: "%ENVIRONMENT(ISTIO_META_CLUSTER_ID)%" # [!code ++]
              mesh: "%ENVIRONMENT(ISTIO_META_MESH_ID)%" # [!code ++]
    rootNamespace: istio-system
    trustDomain: cluster.local
EOF
```

> logFormat.labels的作用就是给输出到loki的日志`添加标签`，在grafana的界面可以通过标签检索到对应的日志。

修改grafana和loki的svc为NodePort并对外暴露30000和30010端口

```bash
$ kubectl -n istio-system patch svc grafana --type='json' -p='[
  {"op":"replace","path":"/spec/type","value":"NodePort"},
  {"op":"replace","path":"/spec/ports/0/nodePort","value":30000}
]'
$ kubectl -n istio-system patch svc loki --type='json' -p='[
  {"op":"replace","path":"/spec/type","value":"NodePort"},
  {"op":"replace","path":"/spec/ports/0/nodePort","value":30010}
]'
```

:::warning

如果集群不是用的Kind的搭建，那么没有必要使用NodePort对外暴露。

:::

在浏览器中输入`IP:30000`来访问grafana，并添加数据源loki，查询访问日志结果如下：

![grafana](https://image.leejay.top/typora/grafana.jpg)

> 通过label标签匹配日志信息，也可以开启右上角的`live`功能，有访问日志会立刻刷新在控制台。

### TelemetryApi

#### 启用访问日志记录

```bash
$ kubectl -n istio-system apply -f - <<EOF
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: mesh-logging-default
spec:
  accessLogging:
  - providers:
    - name: otel
EOF
```

> 这里没有定义selector，所以默认匹配namespace下的所有服务。`如果是根空间(istio-system)，则所有命令空间都生效`。

#### 禁用服务日志记录

```bash
$ kubectl apply -n default -f - <<EOF
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: disable-sleep-logging
spec:
  selector:
    matchLabels:
      app: sleep
  accessLogging:
  - providers:
    - name: otel
    disabled: true # [!code ++]
EOF
```

> 禁用default下的app=sleep的服务的访问日志记录。那么sleep的`出入站日志`都不会被记录。

#### 禁用出/入站日志记录

```bash
$ kubectl apply -f - <<EOF
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: disable-httpbin-logging
spec:
  selector:
    matchLabels:
      app: httpbin
  accessLogging:
  - providers:
    - name: otel
    match: # [!code ++]
      mode: SERVER # [!code ++]
    disabled: true
EOF
```

> |      | CLIENT | SERVER | CLIENT_AND_SERVER |
> | ---- | ------ | ------ | ----------------- |
> | 含义 | 出站   | 入站   | 出站和入站        |
>
> 配合disabled使用，表示禁用`出站、入站或出入站`的访问日志记录。

#### 根据条件记录日志

```bash
$ kubectl apply -f - <<EOF
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: filter-sleep-logging
spec:
  selector:
    matchLabels:
      app: sleep
  accessLogging:
  - providers:
    - name: otel
    filter: # [!code ++]
      expression: response.code <= 200 # [!code ++]
EOF
```

> sleep服务发起的请求(CLIENT)，只有响应码`<=200`的才会被记录（如果sleep处理其他服务发起的请求，则不受影响）。[更多](https://istio.io/latest/zh/docs/tasks/observability/metrics/customize-metrics/#use-expressions-for-values)

## 分布式追踪